<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />

    <title>Big Ben Bonger</title>
</head>                                        

<body>

  <div id="cvas" style="width: 310px; height: 321px; position: absolute; top: 0; left: 0;">
      <canvas id="myCanvas" width="310" height="321" style="border: none;">
      </canvas>
  </div>
                <br /><br /><br />
                <div id="setupButtonDiv" style="float: right">
                <input type="button" class="rounderCorners" id="setup_but" onClick="doSetUp()" style="margin-right: 10px; border: solid 5px #0000aa; margin-top: 230px;" />
 
<img src="img/bb_minute_hand.png" id="mh" style="display:none" /> 
<img src="img/bb_hour_hand.png" id="hh" style="display:none" /> 

                </div>
                <div id="setupPanel">         
                
                <table id="setupTable" style="border: none; float: right; font-size: 12px;">
                  <tr><td align="left" nowrap="nowrap">
                     BONG:&nbsp;<select name="clocker" id="clocker" onChange="changeClock()" style="font-size: 1.1em"></select>
<!--                  
                  <input type="radio" name="whichbuttons" onClick="selectBB()" id="bb_but" style="vertical-align: text-bottom">BIG BEN&nbsp;&nbsp;&nbsp;<input type="radio" name="whichbuttons" id="bg_but" onClick="selectBG()" style="vertical-align: text-bottom"><div id="mantleClk" style="margin: 0; padding: 0; display: inline-block"></div>
-->
                  
                  <br /><span style="color: #0000bb"><hr /></span>
                  <input type="checkbox" class="checkers" name="no_phone_mute" id="no_phone_mute" onClick="doPhoneMute()"><div id="bongDuringCall" style="margin: 0; padding: 0; display: inline-block"></div>
                  <br /><br />
                 
                  
                  
                  <input type="checkbox" class="checkers" name="quart" id="Quarter"  onClick="do1545Option()"><div id="15_45_Label" style="margin: 0; padding: 0; display: inline-block"></div><br />
                  <input type="checkbox" class="checkers" name="half" id="Half"  onClick="doHalfHourOption()"><div id="Half_Label" style="margin: 0; padding: 0; display: inline-block"></div><br />
                  <input type="checkbox" class="checkers" name="hhourr" id="Hour-strikes" onClick="doHourStrikeOption()"><div id="Hour_Label" style="margin: 0; padding: 0; display: inline-block"></div>
                  <br /><br /><img  src="img/juk.png" id="spkr" style="margin: 0; padding: 0; height: 20px; width: 20px; margin-right: 0.8em; margin-top: 0px; margin-bottom: -3px;"  /><input type="button" value="  -  " style="font-size: 1em;  border:none; margin: 0; padding: 0; margin-right: 8px; margin-top: 0px; padding-top: 4px;" onClick="changeVolume('-')" /><progress id="prog" name="prog" value="0.4" max="1.0">
                  </progress><input type="button" value="  +  " style="font-size: 1em;  border:none; margin: 0; padding: 0; margin-left: 0.8em; padding-top: 4px; margin-right: 1.5em;" onClick="changeVolume('+')" />
                  </td></tr></table>
                
                </div>

<!--                <div id="clock"> </div>  -->
<!--                
                <div id="helpDiv">
                  <a href="#" onClick="doHelp()"><img src="img/help.png" width="30" height="30" id="helpIcon" style="margin-left: -3px;" /></a>
                </div>
-->                
                <div id="bottomNavBar" style="background-color: black; margin: 0; padding: 0; height: 54px; position: fixed; bottom: 0%; width: 100%">
                  <img src="img/help.png" width="30" height="30" id="helpIcon" onClick="doHelp()" style="margin-left: 8px; margin-top: 5px;" />
                  <img id="ximage" name="ximage" src="x.png" width="45" height="45" style="float: right; border: none;  padding: 0; margin-top: 5px; margin-right: 8px;" onClick="doExit()" />
                  <img id="minimage" name="minimage" src="img/min.png" width="45" height="45" style="float: right; border: none; margin-top: 5px;" onClick="doGoToBG()" />
                </div>
    </div>

    <script type="text/javascript" src="cordova.js"></script>
     
    <script type="text/javascript" src="js/index.js"></script>
        
    
    <script type="text/javascript" src="js/pluginUtils.js"></script>
    <script type="text/javascript">
      var src;
      var MASTER_MUTE = false;
      var QUARTER_MUTE = false;
      var HALF_MUTE = false;
      var THREE_QUARTER_MUTE = false;
      var DO_STRIKES = true;  
      var MASTER_VOLUME = 0.4;
      var CURRENT_VOLUME = 0.4; 
      var loopDelay;
      var loopThread;
      var QUARTER_HOUR_SYNC = false;
      var ORIENT;
      var SIZE;
      var lastVolumePush = "Neither";
      var my_media_TEST = "NOT_RUNNING";
      var my_media_WHICH = "NOT_RUNNING";
      var my_media2;
      var my_media;      
      
      var QUARTER_DING       = "bb_quarter.mp3";
      var HALF_DING          = "bb_half.mp3";
      var THREE_QUARTER_DING = "bb_three-quarter.mp3";
      var HOUR_DING          = "bb_hour.mp3";
      var DING_SELECTION;
      var do24Hr = false;
      var myLang;
      
      var Timeouter;
      var delayRelease;
      
      var MAGIC_NUMBER = 0;
      var DUP_EXIT = false;
      var startTimeArray = [];
      var nextUp = 0;
      
      var ctx;
      var lang;
      var XStr;
      var setupIsDisplayed = false;
      var helpText, helpTextTitle, mantleClockText, grandfatherClockText, helpDismissText, quitConfirmText, backgroundNotificationText, optionsInText, optionsOutText;
      
      var p = window.location.pathname;
      this.root = p.substring(0, p.lastIndexOf('/')) + "/";
      
      var canvas;
      var ctx;
      var minuteHand = document.getElementById("mh");
      var minuteHandArray = [ [0, -44], [15, -46], [29, -50], [44, -56], [56, -63], [67, -70], [82, -78], [92, -88], [102, -100], [110, -110],          // 0 - 9
          [116, -123], [124, -138], [128, -150], [130, -166], [131, -184], [129,-195], [128, -213], [124, -225], [119, -240], [111, -254],              // 10 - 19
          [106, -265], [96, -277], [85, -287], [73, -296], [61, -304], [46, -310], [35, -317], [19, -321], [5, -325], [-10, -325],                      // 20 - 29
          [-25, -323], [-40, -320], [-55, -317], [-69, -312], [-82, -306], [-94, -303], [-106, -288], [-118, -278], [-125, -268], [-134, -258],         // 30 - 39     
          [-140, -247], [-145, -230], [-149, -215], [-152, -200], [-155, -185], [-156, -174], [-153, -159], [-150, -145], [-144, -130], [-138, -116],   // 40 - 49
          [-130, -104], [-121, -92], [-111, -81], [-99, -71], [-86, -63], [-72, -55], [-59, -53], [-45, -48], [-30, -46], [-15, -45] ];                 // 50 - 59      
      var hourHand = document.getElementById("hh");                                                                                               
      
      function init()   {
        var d = new Date();
        var mins = d.getMinutes();        
        var n = d.getHours();
        var delimiter = ":";
              
        if (do24Hr)   {
          if (localStorage["language"] == "de")   {
            delimiter = ".";
            if (n < 10)   {
              n = "&nbsp;&nbsp;" + n;
            }
          }
          else   {
            if (n < 10)   {
              n = "0" + n;
            }
          }
        }
        else   {                    
          if (n == 0)   {
            n = 12;
          }
          if (n > 12)   {
            n -= 12;
          } 
          
          if (n < 10)   {
            n = "&nbsp;&nbsp;" + n;
          }
        }
          
        if (mins < 10)   {
          mins = "0" + mins;
        } 
//        document.getElementById("clock").innerHTML = "&nbsp;" + n + delimiter + mins + "&nbsp;";
             
        var secs = d.getSeconds();
        loopDelay = (60 - secs) * 1000;
        
// Fix loop creep (I hope)
        loopDelay += 1000;   
        
        doTimeDisplay(d.getHours(), mins);    
        
        
        if (cordova.plugins.backgroundMode.isActive())   {
          cordova.plugins.backgroundMode.configure({ text: backgroundNotificationText  });
        } 
       
        loopThread = setTimeout(doMainLoop, loopDelay);
      }
      
      function doMainLoop()   {
        var d = new Date();
        var mins = d.getMinutes();        
        var n = d.getHours();
        var delimiter = ":"; 
              
        if (do24Hr)   {
          if (localStorage["language"] == "de")   {
            delimiter = ".";
            if (n < 10)   {
              n = "&nbsp;&nbsp;" + n;
            }
          }
          else   {
            if (n < 10)   {
              n = "0" + n;
            }
          }
        }
        else   {    
          if (n == 0)   {
            n = 12;
          }
          if (n > 12)   {
            n -= 12;
          } 
          
          if (n < 10)   {
            n = "&nbsp;&nbsp;" + n;
          }
        }
          
        if (mins < 10)   {
          mins = "0" + mins;
        } 
        
//        document.getElementById("clock").innerHTML = "&nbsp;" + n + delimiter + mins + "&nbsp;";
                 
        if ((mins % 15) == 0)   {
          playBen(mins);
          init();        
        }
        else   {
          doTimeDisplay(d.getHours(), mins);
          loopDelay = 60000;
          loopThread = setTimeout(doMainLoop, loopDelay); 
        }     
      }

      function playBen(x)   {
        var phoneAdjustmentsHaveBeenMade = false;
      
        if (typeof(my_media) == "object")   {
          my_media.stop();
          my_media.release();
        }
        
        if (MASTER_MUTE)   {
          if (document.getElementById("no_phone_mute").checked == true)   {
            MASTER_MUTE = false;
            CURRENT_VOLUME = 0.1; 
            if (CURRENT_VOLUME < 0.1)   {
              CURRENT_VOLUME = 0.1;
            } 
            phoneAdjustmentsHaveBeenMade = true;            
          }
        }
                    
        src = "";
        
        if ((x == "15") && (! QUARTER_MUTE) && (! MASTER_MUTE))   {
          src = this.root + "audio/" + QUARTER_DING;
        }
        else if ((x == "30") && (! HALF_MUTE) && (! MASTER_MUTE))   {
          src = this.root + "audio/" + HALF_DING;
        }
        else if ((x == "45") && (! THREE_QUARTER_MUTE) && (! MASTER_MUTE))   {
          src = this.root + "audio/" + THREE_QUARTER_DING;
        }   
        else if ((x == "00") && (! MASTER_MUTE))   {
          src = this.root + "audio/" + HOUR_DING;
          
          if (DO_STRIKES)   {
            if (typeof(my_media2) == "object")   {
              my_media2.stop();
              my_media2.release();
            }
            
            var deela;          
            if (DING_SELECTION == "bb")   {
              deela = 15800;
            }
            else if (DING_SELECTION == "gf")   {
              deela = 16000;
            }
            else   {
              deela = 13000;
            }
 
            setTimeout(function()   { 
              var d = new Date();
              var n = d.getHours();
              
              if (n == 0)   {
                n = 12;
              }
              if (n > 12)   {
                n -= 12;
              }
              
              var inserter;
                            
              inserter = localStorage["ding_selection"] + "_";
              
              var dingerFile = this.root + "audio/" + inserter + n + ".mp3";
              my_media2 = new Media(dingerFile,
                function () { console.log("playAudio():Audio Success"); },
                ignoreError()
              );
            
              my_media2.play({ playAudioWhenScreenIsLocked : true }); 
              my_media2.setVolume(CURRENT_VOLUME);
              
              if (phoneAdjustmentsHaveBeenMade)   {
                phoneAdjustmentsHaveBeenMade = false;
                CURRENT_VOLUME = MASTER_VOLUME;
                MASTER_MUTE = true;
              }     
            }, deela);      
          }   
        }     
        
        if (src != "")   {
          my_media = new Media(src,
            function () { console.log("playAudio():Audio Success"); },
            ignoreError()
          );
          
          my_media.play({ playAudioWhenScreenIsLocked : true });         
          my_media.setVolume(CURRENT_VOLUME); 
        }
        
        if ((phoneAdjustmentsHaveBeenMade && x != "00") || (phoneAdjustmentsHaveBeenMade && ! DO_STRIKES && x == "00"))   {
          phoneAdjustmentsHaveBeenMade = false;
          CURRENT_VOLUME = MASTER_VOLUME;
          MASTER_MUTE = true;
        }
      }
      
      function initializeCanvas()   {
        canvas = document.getElementById("myCanvas");
        
        if (! canvas.getContext)   {
          alert ('Put in static pic');
          return;
        } 

        ctx = canvas.getContext('2d'); 
//        ctx.translate(104, -17);      
        ctx.translate(116, 127); 
      }
      
      function doTimeDisplay(hrs, minte)   {
        var handPosition;
        var m = parseInt(minte);
        var hourHandPosition;
        
        ctx.clearRect(-116, -127, canvas.width, canvas.height);

        handPosition = m * 6 * Math.PI / 180;
        ctx.rotate(handPosition);       
//        ctx.drawImage(minuteHand, minuteHandArray[m][0],  minuteHandArray[m][1]);
        ctx.drawImage(minuteHand, -13,  -182);
        ctx.rotate(handPosition * -1);

//        ctx.drawImage(hourHand, 0, 83);
        
        hrs %= 12;
       
        hourHandPosition = ((hrs * 6 * 5) * Math.PI / 180) + ((m * 6 * Math.PI / 180) / 12);
        ctx.rotate(hourHandPosition); 
        ctx.drawImage(hourHand, -16, -100); 
        ctx.rotate(hourHandPosition * -1); 
  
//        ctx.drawImage(minuteHand, 0, -44);
//        
//        handPosition = 5 * 6 * Math.PI / 180;
//        ctx.rotate(handPosition);       
//        ctx.drawImage(minuteHand, 67, -70);       
      }
      
      function doSetUp()   {
        var panelStyle = document.getElementById("setupPanel").style;
        var theCheckboxes = document.getElementsByClassName("checkers");
    
        if (! setupIsDisplayed)   {
          setupIsDisplayed = true;
          document.getElementById("setup_but").value = optionsOutText;
//          document.getElementById("clock").style.visibility = 'hidden';
          
          var ratio = window.devicePixelRatio || 1;
          var h = screen.height;

          if (h / ratio > 780)   {
            if (localStorage["language"] == "fr")   {
              panelStyle.width = '380px';
            }
            else if (localStorage["language"] == "pt")   {
              panelStyle.width = '465px';
            }
            else if (localStorage["language"] == "de")   {
              panelStyle.width = '445px';
            }
            else   {
              panelStyle.width = '385px';
            }
  
            panelStyle.height = '350px';
            document.getElementById("setupPanel").style.paddingTop = "30px";
            document.getElementById("Quarter").style.marginTop = "10px";
            document.getElementById("Half").style.marginTop = "8px";
            document.getElementById("Hour-strikes").style.marginTop = "8px";
            document.getElementById("spkr").style.width = "40px";
            document.getElementById("spkr").style.height = "40px";
            document.getElementById("sprk").style.marginBottom = "-8px";            
          }
          else   {
            if (localStorage["language"] == "fr")   {
              panelStyle.width = '235px';
            }
            else if (localStorage["language"] == "pt")   {
              panelStyle.width = '275px';
            }
            else if (localStorage["language"] == "de")   {
              panelStyle.width = '242px';
            }
            else   {
              panelStyle.width = '220px';
            }
              
            panelStyle.height = '200px';
            document.getElementById("setupPanel").style.paddingTop = "2px";
            document.getElementById("spkr").style.width = "22px";
            document.getElementById("spkr").style.height = "22px";
          }          
        } 
        else   {
          setupIsDisplayed = false;
          document.getElementById("setup_but").value = optionsInText;
          panelStyle.width = '0px';
//          setTimeout(function() {document.getElementById("clock").style.visibility = 'visible';}, 2000);          
        }
        
        clearTimeout(loopThread);
        init();      
      }
      
      function selectBB()   {
        DING_SELECTION     = "bb";
        localStorage["ding_selection"] = "bb";
        var dingerFile = this.root + "audio/" + "bb_quarter.mp3";
               
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
        
        if(my_media_TEST != "NOT_RUNNING")   {
          clearTimeout(delayRelease);
          my_media_TEST.stop();
          my_media_TEST.release();
          my_media_TEST = "NOT_RUNNING";
        }
          
        my_media_WHICH = new Media(dingerFile,
           function () { console.log("playAudio():Audio Success"); },
           ignoreError()
        );
        
        my_media_WHICH.play();
        my_media_WHICH.setVolume(MASTER_VOLUME);
                         
        Timeouter = setTimeout(function()   {
            my_media_WHICH.stop(); 
            my_media_WHICH.release();
            my_media_WHICH = "NOT_RUNNING";
          }, 15000);
      }
      
      function selectBG()   {
        DING_SELECTION     = "bg";
        localStorage["ding_selection"] = "bg";
        var dingerFile = this.root + "audio/" + "bg_quarter.mp3";
               
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
        
        if(my_media_TEST != "NOT_RUNNING")   {
          clearTimeout(delayRelease);
          my_media_TEST.stop();
          my_media_TEST.release();
          my_media_TEST = "NOT_RUNNING";
        }        
          
        my_media_WHICH = new Media(dingerFile,
           function () { console.log("playAudio():Audio Success"); },
           ignoreError()
        );
        
        my_media_WHICH.play();
        my_media_WHICH.setVolume(MASTER_VOLUME);
        
        Timeouter = setTimeout(function()   { 
            my_media_WHICH.release();
            my_media_WHICH = "NOT_RUNNING";
          }, 20000);        
      }
      
      function selectGF()   {
        DING_SELECTION     = "gf";
        localStorage["ding_selection"] = "gf";
        var dingerFile = this.root + "audio/" + "gf_quarter.mp3";
               
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
        
        if(my_media_TEST != "NOT_RUNNING")   {
          clearTimeout(delayRelease);
          my_media_TEST.stop();
          my_media_TEST.release();
          my_media_TEST = "NOT_RUNNING";
        }        
          
        my_media_WHICH = new Media(dingerFile,
           function () { console.log("playAudio():Audio Success"); },
           ignoreError()
        );
        
        my_media_WHICH.play();
        my_media_WHICH.setVolume(MASTER_VOLUME);

        Timeouter = setTimeout(function()   { 
            my_media_WHICH.release();
            my_media_WHICH = "NOT_RUNNING";
          }, 20000);        
      }
      

      

      function doHourStrikeOption()   {
        if (DO_STRIKES)   {
          DO_STRIKES = false;
          document.getElementById("Hour-strikes").checked = false;
          localStorage["hour-strikes"] = "no";
        }
        else   {
          DO_STRIKES = true;
          document.getElementById("Hour-strikes").checked = true;
          localStorage["hour-strikes"] = "checked";
        }
      }     
      
      function do1545Option()   {
        if (QUARTER_MUTE)   {
          QUARTER_MUTE = false;
          THREE_QUARTER_MUTE = false;
          document.getElementById("Quarter").checked = true;
          localStorage["quarter"] = "checked";
        }
        else   {
          QUARTER_MUTE = true;
          THREE_QUARTER_MUTE = true;
          document.getElementById("Quarter").checked = false;
          localStorage["quarter"] = "no";
        }
      }     

      function doHalfHourOption()   {
        if (HALF_MUTE)   {
          HALF_MUTE = false;
          document.getElementById("Half").checked = true;
          localStorage["half"] = "checked";
        }
        else   {
          HALF_MUTE = true;
          document.getElementById("Half").checked = false;
          localStorage["half"] = "no";
        }
      } 
      
      function doOnOrientationChange()   {
        var body = document.getElementsByTagName('body')[0];
        var ratio = window.devicePixelRatio || 1;
        var h = screen.height;

        if (h / ratio > 780)   {
          body.style.fontSize = "20px";
          SIZE = "big";
        }
        else   {
          body.style.fontSize = "12px";
          SIZE = "small";
        }
         
        if (screen.height > screen.width) {   
          if (SIZE == "small")   {
            body.style.backgroundImage = 'url(img/bg_pt_sm.png)';
          }
          else   {             
            body.style.backgroundImage = 'url(img/bg1.png)';
          }
//          document.getElementById("titler").style.marginRight = "10px";
          document.getElementById("setup_but").style.marginRight = "10px";
          document.getElementById("setup_but").style.backgroundColor = "#e8e8ff";
//          document.getElementById("clock").style.marginTop = "60%";
          
          ORIENT = 'portrait';
        }
        else   {
          body.style.backgroundImage = 'url(img/bg2.png)';
//          document.getElementById("titler").style.marginRight = "20px";
          document.getElementById("setup_but").style.marginRight = "20px";
          document.getElementById("setup_but").style.backgroundColor = "#e8e8ff";
//          document.getElementById("clock").style.marginTop = "20%";
          
          ORIENT = 'landscape';
        }
      }
      
      doOnOrientationChange()
      window.addEventListener('orientationchange', doOnOrientationChange);

      document.addEventListener("deviceready", starter, false);
      
//     window.onload = setTimeout(function() {starter();}, 2000);


//////////////////////////////////////////////////////
///  STARTER  ////////////////////////////////////////
//////////////////////////////////////////////////////

      function starter()   { 
        
        var ratio = window.devicePixelRatio || 1;
        var h = screen.height;

        if (h / ratio > 780)   {
          document.getElementById("ximage").style.width = "55px";
          document.getElementById("ximage").style.height = "55px";
          document.getElementById("minimage").style.width = "50px";
          document.getElementById("minimage").style.height = "50px";
//          document.getElementById("minimage").style.marginRight = "125px";
          document.getElementById("helpIcon").style.width = "55px";
          document.getElementById("helpIcon").style.height = "55px";
          document.getElementById("no_phone_mute").style.width = "35px";
          document.getElementById("no_phone_mute").style.height = "35px";
          document.getElementById("Quarter").style.width = "35px";
          document.getElementById("Quarter").style.height = "35px";
          document.getElementById("Half").style.width = "35px";
          document.getElementById("Half").style.height = "35px";
          document.getElementById("Hour-strikes").style.width = "35px";
          document.getElementById("Hour-strikes").style.height = "35px";
//          document.getElementById("bb_but").style.width = "30px";
//          document.getElementById("bb_but").style.height = "30px";
//          document.getElementById("bg_but").style.width = "30px";
//          document.getElementById("bg_but").style.height = "30px";
          document.getElementById("setupPanel").style.marginTop = "60px"; 
//          document.getElementById("clocker").style.fontSize = "1.3em";         
        }
        else   {
          document.getElementById("ximage").style.width = "45px";
          document.getElementById("ximage").style.height = "45px";
          document.getElementById("minimage").style.width = "42px";
          document.getElementById("minimage").style.height = "42px";
          document.getElementById("minimage").style.marginTop = "5px";
          document.getElementById("minimage").style.marginRight = "100px";
          document.getElementById("helpIcon").style.width = "45px";
          document.getElementById("helpIcon").style.height = "45px";
          document.getElementById("setupPanel").style.marginTop = "260px"; 
        }  
        
        setLanguage();
        
        processSavedSettings(); 
                        
//        init();
        
        window.plugins.insomnia.keepAwake();
        
        cordova.plugins.backgroundMode.setEnabled(true);
      
        cordova.plugins.backgroundMode.on('activate', function() {
          cordova.plugins.backgroundMode.disableWebViewOptimizations(); 
        });

        cordova.plugins.backgroundMode.setDefaults({
          title: "Big Ben Bonger Background",
          text: backgroundNotificationText,
          resume: false,
          hidden: false
        });
                        
        PhoneCallTrap.onCall(function(state) {
          switch (state) {
            case "RINGING":
                MASTER_MUTE = true;
                break;
            case "OFFHOOK":
                MASTER_MUTE = true;
                break;
            case "IDLE":
                MASTER_MUTE = false;
                break;
          }
        });
        
        document.addEventListener("backbutton", function (e) {               // Disable Back Button
            e.preventDefault();
            var q = confirm(quitConfirmText);
            if (q == true)   {
              doExit();
            } 
            else   {
              ;
            }       
          }, 
        false );


      }
      
      document.addEventListener("resume", onResume, false);
      
      function onResume()   {
        cordova.plugins.backgroundMode.moveToForeground();
        window.plugins.insomnia.keepAwake();
        clearTimeout(loopThread);
        init();
      }
      
      function doExit()   {
        clearTimeout(loopThread);
        if (! DUP_EXIT)   {
          localStorage["locker"] = 0;
        }
        window.plugins.insomnia.allowSleepAgain();
        navigator.app.exitApp();
      }
      
      window.addEventListener("beforeunload", function (event) {
//      event.preventDefault();
        if (! DUP_EXIT)   {
          localStorage["locker"] = 0;
        }
      });
      
      function changeVolume(dir)   {
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
              
        var pBar = document.getElementById("prog");
        
        if(my_media_TEST == "NOT_RUNNING")   {
          var dingerFile = this.root + "audio/" + THREE_QUARTER_DING;
          my_media_TEST = new Media(dingerFile,
                function () { console.log("playAudio():Audio Success"); },
                ignoreError()
          );

          my_media_TEST.play();
          
          var delay;          
          if (DING_SELECTION == "bb")   {
            delay = 20000;
          }
          else   {
            delay = 20000;
          }
          
          delayRelease = setTimeout(function()   { 
            my_media_TEST.stop();
            my_media_TEST.release();
            my_media_TEST = "NOT_RUNNING";
          }, delay);
        } 
        
        if (dir == "+")   {            
          if (MASTER_VOLUME < 1.0)   {
            MASTER_VOLUME =  MASTER_VOLUME + 0.1;
          }
        }
        else   {
          if (MASTER_VOLUME > 0.0)   {
            MASTER_VOLUME = MASTER_VOLUME - 0.1;
          }                    
        }
        
        pBar.value = MASTER_VOLUME;
        my_media_TEST.setVolume(MASTER_VOLUME);
        
        localStorage["volume"] = MASTER_VOLUME.toString();
//        alert (MASTER_VOLUME);
        CURRENT_VOLUME = MASTER_VOLUME;          
      }
      
      function doGoToBG()   { 
        window.plugins.insomnia.allowSleepAgain();
        cordova.plugins.backgroundMode.moveToBackground();      
      }
      
      function doHelp()   {
        navigator.notification.alert(
          helpText,  
          "",         
          helpTextTitle,           
          helpDismissText                 
        );      
      }
            
      function showScreenSize()   {
        var ratio = window.devicePixelRatio || 1;
        var h = screen.height;
        var w = screen.width;
        
//        alert("SCREEN = " + w + " x " + h + "\n RATIO = " + ratio + "\n\nMAGIC_NUMBER =\n" + MAGIC_NUMBER + "  [" + localStorage["locker"] + "]");
      }
      
      function processSavedSettings()   {
//
//  Clock Selection
//      
        if ((localStorage["ding_selection"] == "") || (localStorage["ding_selection"] == null))   {
          localStorage["ding_selection"] = "bb";
        }
        
        if ((localStorage["ding_selection"] != "bb") && (localStorage["ding_selection"] != "bg") && (localStorage["ding_selection"] != "gf"))   {
          localStorage["ding_selection"] = "bb";
        } 
        
        QUARTER_DING = localStorage["ding_selection"] + "_quarter.mp3";
        HALF_DING  = localStorage["ding_selection"] + "_half.mp3";
        THREE_QUARTER_DING = localStorage["ding_selection"] + "_three-quarter.mp3";
        HOUR_DING = localStorage["ding_selection"] + "_hour.mp3";
        DING_SELECTION = localStorage["ding_selection"];

//
//  Mute during Phonecalls
//        
        if ((localStorage["no_phone_mute"] != "checked") && (localStorage["no_phone_mute"] != "no"))   {
          localStorage["no_phone_mute"] = "no";
        }

        if (localStorage["no_phone_mute"] == "checked")   {
          document.getElementById("no_phone_mute").checked = true;
        } 
        else   {
          document.getElementById("no_phone_mute").checked = false;
        }
        
//        alert ("DING: " + localStorage["ding_selection"] + "\n\nMUTE: " + localStorage["no_phone_mute"]);

//
//  15 & 45 Chimes
//
        if ((localStorage["quarter"] != "checked") && (localStorage["quarter"] != "no"))   {
          localStorage["quarter"] = "checked";
        }
        
        if (localStorage["quarter"] == "checked")   {
          QUARTER_MUTE = false;
          THREE_QUARTER_MUTE = false;
          document.getElementById("Quarter").checked = true;
        }
        else   {
          QUARTER_MUTE = true;
          THREE_QUARTER_MUTE = true;
          document.getElementById("Quarter").checked = false;       
        }
  
//
//  Half-hour Chimes
//
        if ((localStorage["half"] != "checked") && (localStorage["half"] != "no"))   {
          localStorage["half"] = "checked";
        }
        
        if (localStorage["half"] == "checked")   {
          HALF_MUTE = false;
          document.getElementById("Half").checked = true;
       }
        else   {
          HALF_MUTE = true;
          document.getElementById("Half").checked = false;
        }

//
//  On-the-hour Strikes
//
        if ((localStorage["hour-strikes"] != "checked") && (localStorage["hour-strikes"] != "no"))   {
          localStorage["hour-strikes"] = "checked";
        }
        
        if (localStorage["hour-strikes"] == "checked")   {
          DO_STRIKES = true;
          document.getElementById("Hour-strikes").checked = true;
       }
        else   {
          DO_STRIKES = false;
          document.getElementById("Hour-strikes").checked = false;
        }        

//
//  Volume
//
        if ((localStorage["volume"] == "undefined") || (localStorage["volume"] == "") || (localStorage["volume"] == null))   {
          localStorage["volume"] = "0.3";
        }
        
        if (parseFloat(localStorage["volume"]) < 0.1)   {
          localStorage["volume"] = "0.1";
        }
        else if (parseFloat(localStorage["volume"]) > 1.0)   {
          localStorage["volume"] = "1.0";
        }
        
        MASTER_VOLUME = parseFloat(localStorage["volume"]);
        CURRENT_VOLUME = MASTER_VOLUME;
        document.getElementById("prog").value = CURRENT_VOLUME;     
      }
      
      function doPhoneMute()   {
        if (document.getElementById("no_phone_mute").checked == true)   {
          localStorage["no_phone_mute"] = "checked";
        } 
        else   {
          localStorage["no_phone_mute"] = "no";
        }       
      }
      
    
      function setLanguage()   {
        
        localStorage["language"] = ""; 
      
        navigator.globalization.getPreferredLanguage( function (language)   {
          myLang = language.value.substring(0, 2);
          localStorage["language"] = myLang;
                     
          if (localStorage["language"] == "pt")   { 
            do24Hr = true;         
//            document.getElementById("titler").innerHTML = "BIG BEN BONGER";
            document.getElementById("setup_but").value = "< OPÇÕES"; 
            mantleClockText = "RELÓGIO MANTEL";
            grandfatherClockText = "RELÓGIO AVÔ";
            document.getElementById("bongDuringCall").innerHTML = "&nbsp;BONG DURANTE O CHAMADO DE TELEFONE";
            document.getElementById("15_45_Label").innerHTML = "&nbsp;:15 e :45 CHIMES";
            document.getElementById("Half_Label").innerHTML = "&nbsp;MEIA HORA";
            document.getElementById("Hour_Label").innerHTML = "&nbsp;CHIMES HORAIS";
            helpText = "Deixe o Big Ben V1.3 ajudá-lo quando você não quer perder o tempo - perfeito ao ler, trabalhar, estudar ou mesmo fazer compras - um lembrete sutil a cada 15 minutos.\n\n";
            helpText += "Toque no botão [<OPÇÕES] para ajustar as configurações. Suas configurações são sempre salvas. Quando terminar, toque o botão [OPÇÕES>] novamente. Você pode deixar Ben assim e ele irá exibir o tempo e o bongo para você o dia todo.\n\n";
            helpText += "Mas provavelmente você quer fazer outras coisas com seu telefone ou tablet. Você pode minimizar Big Ben tocando no quadrado Minimizar Ícone na parte superior da tela. Big Ben continuará a bong até você sair do aplicativo.\n\n";
            helpText += "Para voltar a maximizar o Bonger, toque o ícone Big Ben. Você pode então sair do aplicativo usando o ícone \"X\" no canto superior direito. Obrigado por escolher o Big Ben Bonger.\n\n";
            helpText += "Deus salve a rainha.\n\n\numikeapps@outlook.com";
            helpTextTitle = "Bem-vindo ao Big Ben Bonger"; 
            helpDismissText = "DISPENSAR";
            quitConfirmText = "Você quer sair do Big Ben Bonger?";
            backgroundNotificationText = "Toque no ícone Big Ben para restaurar"; 
            optionsInText = "< OPÇÕES";
            optionsOutText = "OPÇÕES >";
          }
          else if (localStorage["language"] == "fr")   {
            do24Hr = true;
//            document.getElementById("titler").innerHTML = "BIG BEN BONGER";
            document.getElementById("setup_but").value = "< OPTIONS";
            mantleClockText = "HORLOGE MANTELLE";
            grandfatherClockText = "HORLOGE GRAND-PÈRE";
            document.getElementById("bongDuringCall").innerHTML = " BONG DURANT LE TÉLÉPHONE"; 
            document.getElementById("15_45_Label").innerHTML = "&nbsp;:15 &amp; :45 CHIMES";
            document.getElementById("Half_Label").innerHTML = "&nbsp;DEMI-PASSÉ";
            document.getElementById("Hour_Label").innerHTML = "&nbsp;CHIMES HORAIRES";
            helpText = "Laissez Big Ben V1.3 vous aider lorsque vous ne voulez pas perdre la trace du temps -- parfait lors de la lecture, du travail, des études ou même des achats -- un rappel subtil toutes les 15 minutes.\n\n";                    
            helpText += "Appuyez sur le bouton [< OPTIONS] pour ajuster les paramètres. Vos paramètres sont toujours sauvegardés. Une fois terminé, appuyez de nouveau sur le bouton [OPTIONS >]. Vous pouvez laisser Ben comme ça et il vous montrera le temps et le bong pour vous toute la journée.\n\n";       
            helpText += "Mais vous voudrez probablement faire d'autres choses avec votre téléphone ou votre tablette. Vous pouvez minimiser Big Ben en tapotant l'icône Minimiser carré en haut de l'écran. Big Ben continuera à bong jusqu'à ce que vous quittez l'application.\n\n";       
            helpText += "Pour re-maximiser le Bonger, appuyez sur l'icône Big Ben. Vous pouvez ensuite quitter l'application à l'aide de l'icône \"X\" dans le coin supérieur droit. Merci d'avoir choisi le Big Ben Bonger.\n\n";       
            helpText += "Dieu sauve la reine.\n\n\numikeapps@outlook.com";
            helpTextTitle = "Bienvenue au Big Ben Bonger";
            helpDismissText ="RENVOYER";
            quitConfirmText = "Voulez-vous quitter Big Ben Bonger?";
            backgroundNotificationText = "Appuyez sur l'icône Big Ben pour restaurer";
            optionsInText = "< OPTIONS";
            optionsOutText = "OPTIONS >";
          }          
          else if (localStorage["language"] == "de")   {
            do24Hr = true;
//            document.getElementById("titler").innerHTML = "BIG BEN BONGER";
            document.getElementById("setup_but").value = "< OPTIONEN";
            mantleClockText = "UHR MANTEL";
            grandfatherClockText = "UHR GROßVATER";
            document.getElementById("bongDuringCall").innerHTML = " BONG WÄHREND DER TELEFONATE"; 
            document.getElementById("15_45_Label").innerHTML = "&nbsp;:15 &amp; :45 GLOCKENSPIEL";
            document.getElementById("Half_Label").innerHTML = "&nbsp;HALBE STUNDE GLOCKENSPIEL";
            document.getElementById("Hour_Label").innerHTML = "&nbsp;STÜNDLICH GLOCKENSPIEL";
            helpText = "Lassen Sie Big Ben V1.3 Ihnen helfen, wenn Sie nicht wollen, Zeit zu verlieren - ideal zum Lesen, Arbeiten, Studieren oder sogar beim Einkaufen - Eine subtile Erinnerung alle 15 Minuten.\n\n";                    
            helpText += "Tippen Sie auf die Schaltfläche [<OPTIONS], um die Einstellungen anzupassen. Ihre Einstellungen werden immer gespeichert. Wenn Sie fertig sind, tippen Sie erneut auf die Schaltfläche [OPTIONEN>]. Du kannst Ben so verlassen und er wird die Zeit und die Bong für dich den ganzen Tag zeigen.\n\n";       
            helpText += "Aber am ehesten werden Sie wollen, um andere Dinge mit Ihrem Telefon oder Tablette zu tun. Sie können Big Ben minimieren, indem Sie das Minimize Icon am oberen Bildschirmrand tippen. Big Ben wird weiterhin bong, bis du die App verlässt.\n\n";       
            helpText += "Um die Größe zu maximieren, tippen Sie auf das Big Ben Symbol. Sie können dann mit dem \"X\" Symbol in der oberen rechten Ecke der App enden. Vielen Dank für die Wahl der Big Ben Bonger.\n\n";       
            helpText += "Gott schütze die Königin.\n\n\numikeapps@outlook.com";
            helpTextTitle = "Willkommen bei den Big Ben Bonger";
            helpDismissText ="SCHLIEßEB";
            quitConfirmText = "Willst du Big Ben Bonger verlassen?";
            backgroundNotificationText = "Tippen Sie auf das Big Ben Icon, um es wiederherzustellen";
            optionsInText = "< OPTIONEN";
            optionsOutText = "OPTIONEN >";
          }         
          else   {               
//            document.getElementById("titler").innerHTML = "BIG BEN BONGER";
            document.getElementById("setup_but").value = "< OPTIONS";
            mantleClockText = "MANTLE CLOCK";
            grandfatherClockText = "GRANDFATHER CLOCK";
            document.getElementById("bongDuringCall").innerHTML = "&nbsp;BONG DURING PHONECALLS";
            document.getElementById("15_45_Label").innerHTML = "&nbsp;:15 &amp; :45 CHIMES";
            document.getElementById("Half_Label").innerHTML = "&nbsp;HALF HOUR CHIMES";
            document.getElementById("Hour_Label").innerHTML = "&nbsp;ON-THE-HOUR STRIKES";             
            helpText = "Let Big Ben V1.3 help you when you don't want to lose track of time -- perfect when reading, working, studying or even shopping -- a subtle reminder every 15 minutes.\n\n";
            helpText += "Tap the [< OPTIONS] button to adjust settings. Your settings are always saved.  When finished, tap the [OPTIONS >] button again.  You can leave Ben like this and he'll display the time and bong for you all day.\n\n";
            helpText += "But most likely you'll want to do other things with your phone or tablet. You can minimize Big Ben by tapping the square Minimize Icon at the top of the screen. Big Ben will continue to bong until you exit the app.\n\n";
            helpText += "To re-maximize the Bonger, tap the Big Ben icon. You can then exit the app using the \"X\" Icon in the upper right corner. Thank you for choosing the Big Ben Bonger.\n\n";
            helpText += "God Save The Queen.\n\n\numikeapps@outlook.com";
            helpTextTitle = "Welcome to the Big Ben Bonger"; 
            helpDismissText = "DISMISS";
            quitConfirmText = "Do you want to exit Big Ben Bonger?";
            backgroundNotificationText = "Tap the Big Ben Icon to Restore";
            optionsInText = "< OPTIONS";
            optionsOutText = "OPTIONS >";
          } 

//
//  Add Select options
//          
          var x = document.getElementById("clocker");
          
          var b = document.createElement("option");
          b.text = "BIG BEN";
          b.value = "bb";
          
          if ((localStorage["ding_selection"] != "bg") && (localStorage["ding_selection"] != "gf"))  {
            b.selected = true;
          }

          x.options.add(b, 0);
          
          var c = document.createElement("option");
          c.text = mantleClockText;
          c.value = "bg";
          
          if (localStorage["ding_selection"] == "bg")   {
            c.selected = true;
          }
          
          x.options.add(c, 1);

          var d = document.createElement("option");
          d.text = grandfatherClockText;
          d.value = "gf";
          
          if (localStorage["ding_selection"] == "gf")   {
            d.selected = true;
          }
          
          x.options.add(d, 2);
          
          initializeCanvas();
          init();
        },        
        ignoreError2() ); 

      } 
      
      function changeClock()   {
        var xx = document.getElementById("clocker");
        var theValue = xx.options[xx.selectedIndex].value;
        localStorage["ding_selection"] = theValue;
        
//        alert("The value of your clock is " + theValue);

        if (theValue == "bb")   {
          selectBB();
        }
        else if (theValue == "bg")   {
          selectBG();
        }
        else   {
          selectGF();
        }
        
        QUARTER_DING = localStorage["ding_selection"] + "_quarter.mp3";
        HALF_DING  = localStorage["ding_selection"] + "_half.mp3";
        THREE_QUARTER_DING = localStorage["ding_selection"] + "_three-quarter.mp3";
        HOUR_DING = localStorage["ding_selection"] + "_hour.mp3";
        DING_SELECTION = localStorage["ding_selection"];

      
      }              
      
                      

      function ignoreError(err){
        ;
      }
 
      function ignoreError2(){
        ;
      }
     
            
      

    </script>
  
</body>

</html>
