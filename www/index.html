<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />

    <title>Big Ben Bonger</title>
</head>

<body>
        <div id="versioner" style="color: white; margin-left: 5px; margin-top: 5px;" onClick="showScreenSize()">v 3.0.2</div>
        <div id="xer"><img id="ximage" src="img/x.png" width="30" height="31" style="border: none; border_top: 4px;" onClick="doExit()" /></div>

       <br /><br /><h1 id="titler">BIG BEN BONGER</h1>   

                <br />
                <div id="setupButtonDiv" style="float: right">
                <input type="button" class="rounderCorners" id="setup_but" value="< SETUP" onClick="doSetUp()" style="margin-right: 10px;" />
                </div>
                <div id="setupPanel">
                
                <table style="border: none; float: right;">
                  <tr><td align="left">
                  <input type="radio" name="whichbuttons" onClick="selectBB()" id="bb_but" checked style="vertical-align: text-bottom">BIG BEN&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="whichbuttons" id="bg_but" onClick="selectBG()" style="vertical-align: text-bottom">MANTLE CLOCK
                  <br /><br />
                 
                  
                  <span style="font-size: 1.2em; color: #0000bb">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHIMES &amp; STRIKERS</span><br />
                  <input type="checkbox" name="quart" id="Quarter" checked onClick="doQuarterHourOption()">Quarter-Hour<br />
                  <input type="checkbox" name="half" id="Half" checked onClick="doHalfHourOption()"> Half-Hour<br />
                  <input type="checkbox" name="three-quart" id="Three-quarters" checked onClick="doThreeQuarterOption()"> Three-Quarter-Hour<br />
                  <input type="checkbox" name="hhourr" id="Hour-strikes" onClick="doHourStrikeOption()" checked> Hour Strikes
                  <br /><br /><img  src="img/juk.png" id="spkr" style="margin: 0; padding: 0; height: 20px; width: 20px; margin-right: 8px; margin-top: 0px;"  /><input type="button" value="-" style="height: 19px; width: 15px; border:none; margin: 0; padding: 0; margin-right: 8px; margin-top: 0px; padding-top: 4px;" onClick="changeVolume('-')" /><progress id="prog" name="prog" value="0.4" max="1.0" style="width: 110px; height: 8px; margin: 0; padding: 0; margin-bottom: 4px;">
                  </progress><input type="button" value="+" style="height: 19px; width: 15px; border:none; margin: 0; padding: 0; margin-left: 8px; padding-top: 4px;" onClick="changeVolume('+')" />
                  </td></tr></table>
                
                </div>
                <div id="clock">
                </div>

    </div>

    <script type="text/javascript" src="cordova.js"></script>
     
    <script type="text/javascript" src="js/index.js"></script>
        
    
    <script type="text/javascript" src="js/pluginUtils.js"></script>
    <script type="text/javascript">
      var src;
      var MASTER_MUTE = false;
      var QUARTER_MUTE = false;
      var HALF_MUTE = false;
      var THREE_QUARTER_MUTE = false;
      var DO_STRIKES = true;  
      var MASTER_VOLUME = 0.4; 
      var loopDelay;
      var loopThread;
      var QUARTER_HOUR_SYNC = false;
      var ORIENT;
      var lastVolumePush = "Neither";
      var my_media_TEST = "NOT_RUNNING";
      var my_media_WHICH = "NOT_RUNNING";
      var my_media2;
      var my_media;      
      
      var QUARTER_DING       = "bb_quarter.mp3";
      var HALF_DING          = "bb_half.mp3";
      var THREE_QUARTER_DING = "bb_three-quarter.mp3";
      var HOUR_DING          = "bb_hour.mp3";
      var DING_SELECTION     = "bb";
      
      var Timeouter;
      
      var p = window.location.pathname;
      this.root = p.substring(0, p.lastIndexOf('/')) + "/";
      
      function init()   {
        var d = new Date();
        var mins = d.getMinutes();
        var n = d.getHours();
              
        if (n == 0)   {
          n = 12;
        }
        if (n > 12)   {
          n -= 12;
        } 
        
        if (mins < 10)   {
          mins = "0" + mins;
        } 
        
        if (n < 10)   {
          n = "&nbsp;&nbsp;" + n;
        }
        
        document.getElementById("clock").innerHTML = "&nbsp;" + n + ":" + mins + "&nbsp;";
             
        var secs = d.getSeconds();
        loopDelay = (60 - secs) * 1000;
        
// Fix loop creep (I hope)
        loopDelay += 1000;        
       
        loopThread = setTimeout(doMainLoop, loopDelay);
      }
      
      function doMainLoop()   {
        var d = new Date();
        var mins = d.getMinutes();
        
        var n = d.getHours();
              
        if (n == 0)   {
          n = 12;
        }
        if (n > 12)   {
          n -= 12;
        } 
        
        if (n < 10)   {
          n = "&nbsp;&nbsp;" + n;
        }

          
        if (mins < 10)   {
          mins = "0" + mins;
        } 
        
        document.getElementById("clock").innerHTML = "&nbsp;" + n + ":" + mins + "&nbsp;";
                 
        if ((mins % 15) == 0)   {
          playBen(mins);
          init();        
        }
        else   {
          loopDelay = 60000;
          loopThread = setTimeout(doMainLoop, loopDelay); 
        }     
      }

      function playBen(x)   {
//        if (typeof my_media == "object") {
//          my_media.stop();
//          my_media.release();
//        }
        
        src = "";
        
        if ((x == "15") && (! QUARTER_MUTE) && (! MASTER_MUTE))   {
          src = this.root + "audio/" + QUARTER_DING;
        }
        else if ((x == "30") && (! HALF_MUTE) && (! MASTER_MUTE))   {
          src = this.root + "audio/" + HALF_DING;
        }
        else if ((x == "45") && (! THREE_QUARTER_MUTE) && (! MASTER_MUTE))   {
          src = this.root + "audio/" + THREE_QUARTER_DING;
        }   
        else if ((x == "00") && (! MASTER_MUTE))   {
          src = this.root + "audio/" + HOUR_DING;
          
          if (DO_STRIKES)   {
            my_media2.release();
            setTimeout(function()   { 
              var d = new Date();
              var n = d.getHours();
              
              if (n == 0)   {
                n = 12;
              }
              if (n > 12)   {
                n -= 12;
              }
              
              var inserter;
              
              
              inserter = (DING_SELECTION == "bb") ? "bb_" : "bg_";
              
              var dingerFile = this.root + "audio/" + inserter + n + ".mp3";
              my_media2 = new Media(dingerFile,
                function () { console.log("playAudio():Audio Success"); },
                function (err) { alert ("playAudio():Audio Error: " + JSON.stringify(err)); }
              );
            
              my_media2.play({ playAudioWhenScreenIsLocked : true }); 
              my_media2.setVolume(MASTER_VOLUME);         
     
            }, 17000);      
          }   
        }     
        
        if (src != "")   {
          my_media = new Media(src,
            function () { console.log("playAudio():Audio Success"); },
            function (err) { alert ("playAudio():Audio Error: " + JSON.stringify(err)); }
          );
          
          my_media.play({ playAudioWhenScreenIsLocked : true });         
          my_media.setVolume(MASTER_VOLUME);
        }
       
      }
      
      function doSetUp()   {
        var panelStyle = document.getElementById("setupPanel").style;
    
        if (document.getElementById("setup_but").value == "< SETUP")   {
          document.getElementById("setup_but").value = "SETUP >";
          document.getElementById("clock").style.visibility = 'hidden';
          panelStyle.width = '205px';
        } 
        else   {
          document.getElementById("setup_but").value = "< SETUP";
          panelStyle.width = '0px';
          setTimeout(function() {document.getElementById("clock").style.visibility = 'visible';}, 2000);          
        }      
      }
      
      function selectBB()   {
        DING_SELECTION     = "bb";
        var dingerFile = this.root + "audio/" + QUARTER_DING;
               
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
        
        if(my_media_TEST != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_TEST.stop();
          my_media_TEST.release();
          my_media_TEST = "NOT_RUNNING";
        }
          
        my_media_WHICH = new Media(dingerFile,
           function () { console.log("playAudio():Audio Success"); },
           function (err) { alert ("playAudio():Audio Error: " + JSON.stringify(err)); }
        );
        
        my_media_WHICH.play();
        my_media_WHICH.setVolume(MASTER_VOLUME);
        
        QUARTER_DING       = "bb_quarter.mp3";
        HALF_DING          = "bb_half.mp3";
        THREE_QUARTER_DING = "bb_three-quarter.mp3";
        HOUR_DING          = "bb_hour.mp3";
                  
        Timeouter = setTimeout(function()   { 
            my_media_WHICH = "NOT_RUNNING";
          }, 15000);
      }
      
      function selectBG()   {
        DING_SELECTION     = "bg";
        var dingerFile = this.root + "audio/" + QUARTER_DING;
               
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
        
        if(my_media_TEST != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_TEST.stop();
          my_media_TEST.release();
          my_media_TEST = "NOT_RUNNING";
        }        
          
        my_media_WHICH = new Media(dingerFile,
           function () { console.log("playAudio():Audio Success"); },
           function (err) { alert ("playAudio():Audio Error: " + JSON.stringify(err)); }
        );
        
        my_media_WHICH.play();
        my_media_WHICH.setVolume(MASTER_VOLUME);
        
        QUARTER_DING       = "bg_quarter.mp3";
        HALF_DING          = "bg_half.mp3";
        THREE_QUARTER_DING = "bg_three-quarter.mp3";
        HOUR_DING          = "bg_hour.mp3";

        Timeouter = setTimeout(function()   { 
            my_media_WHICH = "NOT_RUNNING";
          }, 20000);        
      }

/////////////////      
//      function doDisable()   {
//        document.getElementById("Quarter").checked = false;
//        document.getElementById("Half").checked = false;
//        document.getElementById("Three-quarters").checked = false;
//        document.getElementById("Hour-strikes").checked = false;
//        document.getElementById("enable_but").checked = false;
//        document.getElementById("clock").innerHTML = "&nbsp;"
//        
//        QUARTER_MUTE = true;
//        HALF_MUTE = true;
//       THREE_QUARTER_MUTE = true;
//       DO_STRIKES = false;
//        
//        clearTimeout(loopThread);  
//      } 
////////////////////
      
      function doHourStrikeOption()   {
        if (DO_STRIKES)   {
          DO_STRIKES = false;
          document.getElementById("Hour-strikes").checked = false;
        }
        else   {
          DO_STRIKES = true;
          document.getElementById("Hour-strikes").checked = true;
        }
      }     
      
      function doQuarterHourOption()   {
        if (QUARTER_MUTE)   {
          QUARTER_MUTE = false;
          document.getElementById("Quarter").checked = true;
        }
        else   {
          QUARTER_MUTE = true;
          document.getElementById("Quarter").checked = false;
        }
      }     

      function doHalfHourOption()   {
        if (HALF_MUTE)   {
          HALF_MUTE = false;
          document.getElementById("Half").checked = true;
        }
        else   {
          HALF_MUTE = true;
          document.getElementById("Half").checked = false;
        }
      } 
      
      function doThreeQuarterOption()   {
        if (THREE_QUARTER_MUTE)   {
          THREE_QUARTER_MUTE = false;
          document.getElementById("Three-quarters").checked = true;
        }
        else   {
          THREE_QUARTER_MUTE = true;
          document.getElementById("Three-quarters").checked = false;
        }
      } 
      
      function doOnOrientationChange()   {
        var body = document.getElementsByTagName('body')[0];
         
      if (screen.height > screen.width) {
//          alert ("width = " + screen.width + ";  height = " + screen.height + ";");
      
        body.style.backgroundImage = 'url(img/bg1.png)';
        document.getElementById("titler").style.marginRight = "10px";
        document.getElementById("setup_but").style.marginRight = "10px";
        document.getElementById("clock").style.marginTop = "60%";

        ORIENT = 'portrait';
      }
      else   {
        body.style.backgroundImage = 'url(img/bg2.png)';
        document.getElementById("titler").style.marginRight = "20px";
        document.getElementById("setup_but").style.marginRight = "20px";
        document.getElementById("clock").style.marginTop = "20%";
       
        ORIENT = 'landscape';
      }
    }
    
      doOnOrientationChange()
      window.addEventListener('orientationchange', doOnOrientationChange);

      document.addEventListener("deviceready", starter, false);
      
//     window.onload = setTimeout(function() {starter();}, 2000);

      function starter()   {
        document.getElementById("clock").style.visibility = 'visible';
        init();
        window.plugins.insomnia.keepAwake();
        
        cordova.plugins.backgroundMode.setEnabled(true);
        cordova.plugins.backgroundMode.enable();
        
        cordova.plugins.backgroundMode.on('activate', function() {
          cordova.plugins.backgroundMode.disableWebViewOptimizations(); 
        });
        
        cordova.plugins.backgroundMode.setDefaults({
          title: "Big Ben Bonger Background",
          text: "[Tap here to restore]",
        });
        
        cordova.plugins.backgroundMode.overrideBackButton();
      }       
      
     
////////////////////
//      window.onload = function ()   { 
//        document.getElementById("clock").style.visibility = 'visible';
//        init();
//        window.plugins.insomnia.keepAwake();
//        
//        alert(toJSON(window.plugins));
//        alert(toJSON(cordova.plugins));
//        
//        cordova.plugins.backgroundMode.setEnabled(true);
//      };
///////////////////      
      

      document.addEventListener("resume", onResume, false);
      
      function onResume()   {
        clearTimeout(loopThread);
        init();
      }
      
      function doExit()   {
        clearTimeout(loopThread);
        window.plugins.insomnia.allowSleepAgain();
        navigator.app.exitApp();
      }
      
      function changeVolume(dir)   {
        if(my_media_WHICH != "NOT_RUNNING")   {
          clearTimeout(Timeouter);
          my_media_WHICH.stop();
          my_media_WHICH.release();
          my_media_WHICH = "NOT_RUNNING";
        }
              
        var pBar = document.getElementById("prog");
        
        if(my_media_TEST == "NOT_RUNNING")   {
          var dingerFile = this.root + "audio/" + THREE_QUARTER_DING;
          my_media_TEST = new Media(dingerFile,
                function () { console.log("playAudio():Audio Success"); },
                function (err) { alert ("playAudio():Audio Error: " + JSON.stringify(err)); }
          );

          my_media_TEST.play();
          
          setTimeout(function()   { 
            my_media_TEST.release();
            my_media_TEST = "NOT_RUNNING";
          }, 15000);
        } 
        
        if (dir == "+")   {            
          if (MASTER_VOLUME < 1.0)   {
            MASTER_VOLUME += 0.1;
            pBar.value = MASTER_VOLUME;
            my_media_TEST.setVolume(MASTER_VOLUME);
          }
        }
        else   {
          if (MASTER_VOLUME > 0.0)   {
            MASTER_VOLUME -= 0.1;
            pBar.value = MASTER_VOLUME;
            my_media_TEST.setVolume(MASTER_VOLUME);
          }
        }          
      }
      
      function showScreenSize()   {
        var ratio = window.devicePixelRatio || 1;
        var h = screen.height * ratio;
        var w = screen.width * ratio;
        
        alert("" + w + " x " + h + "\r RATIO = " + ratio);
      }

    </script>
  
</body>

</html>
